<!DOCTYPE html>
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tradition Colombia — Agro Data</title>
  <meta name="description" content="Estadísticas, índices y precios de referencia del agro colombiano para afiliados de Tradition Colombia." />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0E9F6E', // verde dominante (más verde)
            secondary: '#0F4C81', // azul corporativo de apoyo
            dark: '#0B1220',
            muted: '#6B7280',
            surface: '#F3F4F6'
          }
        }
      }
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; }
    .card { box-shadow: 0 8px 24px rgba(2, 6, 23, 0.06); border-radius: 1rem; background: #fff; border: 1px solid #eef2f7; }
    .btn  { display:inline-flex; align-items:center; justify-content:center; border-radius: 0.75rem; padding: 0.6rem 1rem; font-weight: 600; transition: .2s; }
    .btn-primary { background: #0E9F6E; color: white; }
    .btn-primary:hover { opacity: .95 }
    .btn-outline { border: 1px solid #0E9F6E; color: #0E9F6E; }
    .btn-outline:hover { background:#0E9F6E; color:#fff }
    .nav-link { font-weight: 600; color: #475569 }
    .nav-link:hover { color: #0E9F6E }
    .section { scroll-margin-top: 96px; }
    .kpi-up { color:#065f46; background:#d1fae5 }
    .kpi-down { color:#991b1b; background:#fee2e2 }
    .dot { width:10px; height:10px; border-radius:9999px; display:inline-block }
  </style>
</head>
<body class="bg-surface text-dark">
  <!-- Navbar -->
  <header class="sticky top-0 z-40 bg-white/85 backdrop-blur border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="/mnt/data/Logo - Tradition Colombia.png" alt="Tradition Colombia" class="h-8 w-auto"/>
          <div class="font-semibold text-secondary text-lg">Agro Data</div>
        </div>
        <nav class="hidden md:flex items-center gap-6">
          <a href="#inicio" class="nav-link">Inicio</a>
          <a href="#nosotros" class="nav-link">Nosotros</a>
          <a href="#normativa" class="nav-link">Normativa</a>
          <a href="#pqr" class="nav-link">PQR</a>
          <a href="#dashboard" class="nav-link hidden" id="link-privado">Panel</a>
        </nav>
        <div class="flex items-center gap-3">
          <button id="btn-login" class="btn btn-outline text-sm">Iniciar sesión</button>
          <button id="btn-logout" class="btn btn-primary text-sm hidden">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero / Inicio con más datos y mini-curvas -->
  <section id="inicio" class="section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      <div class="grid lg:grid-cols-2 gap-8 items-start">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-dark">Datos accionables del agro colombiano<span class="text-primary"> orientados a precio</span></h1>
          <p class="mt-4 text-gray-600">Comparativos por <strong>producto</strong> y <strong>región</strong>, curvas <strong>spot</strong> y <strong>futuros</strong>, estacionalidad y un <strong>índice agro</strong> propietario. Acceso privado para afiliados.</p>
          <div class="mt-6 flex gap-3">
            <a href="#dashboard" class="btn btn-primary" id="cta-panel">Ir al Panel</a>
            <a href="#pqr" class="btn btn-outline">Radicar PQR</a>
          </div>

          <!-- KPIs con variación WoW -->
          <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card p-4">
              <div class="text-sm text-muted">Café pergamino</div>
              <div class="flex items-baseline gap-2 mt-1"><div id="kpi-cafe" class="text-2xl font-bold">—</div><span id="kpi-cafe-wow" class="text-xs px-2 py-0.5 rounded-full">—</span></div>
              <div class="text-xs text-muted mt-1">COP/kg · promedio nacional</div>
            </div>
            <div class="card p-4">
              <div class="text-sm text-muted">Maíz amarillo</div>
              <div class="flex items-baseline gap-2 mt-1"><div id="kpi-maiz" class="text-2xl font-bold">—</div><span id="kpi-maiz-wow" class="text-xs px-2 py-0.5 rounded-full">—</span></div>
              <div class="text-xs text-muted mt-1">COP/kg · promedio nacional</div>
            </div>
            <div class="card p-4">
              <div class="text-sm text-muted">Arroz paddy</div>
              <div class="flex items-baseline gap-2 mt-1"><div id="kpi-arroz" class="text-2xl font-bold">—</div><span id="kpi-arroz-wow" class="text-xs px-2 py-0.5 rounded-full">—</span></div>
              <div class="text-xs text-muted mt-1">COP/kg · promedio nacional</div>
            </div>
            <div class="card p-4">
              <div class="text-sm text-muted">Índice Agro Tradition</div>
              <div class="flex items-baseline gap-2 mt-1"><div id="kpi-indice" class="text-2xl font-bold">—</div><span id="kpi-indice-wow" class="text-xs px-2 py-0.5 rounded-full">—</span></div>
              <div class="text-xs text-muted mt-1">Base 100 = Ene</div>
            </div>
          </div>
        </div>
        <div class="grid gap-4">
          <div class="card p-4">
            <h3 class="font-semibold mb-2 text-secondary">Curvas públicas — Spot (muestra)</h3>
            <canvas id="chartPublic"></canvas>
          </div>
          <div class="card p-4">
            <h3 class="font-semibold mb-2 text-secondary">Mapa interactivo — Regiones de cosecha</h3>
            <!-- Mapa SVG simplificado -->
            <svg id="mapCol" viewBox="0 0 320 280" class="w-full h-56">
              <!-- Silueta simple -->
              <rect x="0" y="0" width="320" height="280" rx="16" fill="#ecfdf5" />
              <!-- Regiones (puntos representativos) -->
              <g fill="#0E9F6E">
                <circle cx="120" cy="110" r="10" data-region="antioquia" class="cursor-pointer opacity-80"/>
                <circle cx="170" cy="120" r="10" data-region="santander" class="cursor-pointer opacity-80"/>
                <circle cx="150" cy="160" r="10" data-region="tolima" class="cursor-pointer opacity-80"/>
                <circle cx="135" cy="185" r="10" data-region="huila" class="cursor-pointer opacity-80"/>
                <circle cx="210" cy="200" r="10" data-region="meta" class="cursor-pointer opacity-80"/>
              </g>
              <g font-size="10" fill="#065f46" font-weight="600">
                <text x="110" y="100">Antioquia</text>
                <text x="160" y="110">Santander</text>
                <text x="140" y="150">Tolima</text>
                <text x="125" y="175">Huila</text>
                <text x="200" y="190">Meta</text>
              </g>
            </svg>
            <p class="text-xs text-muted mt-1">Clic en una región para ver comparación por producto en el panel.</p>
          </div>
        </div>
      </div>

      <!-- Mini-grid de curvas adicionales en Home -->
      <div class="mt-8 grid md:grid-cols-3 gap-4">
        <div class="card p-4"><h4 class="font-semibold mb-2">Curva de futuros (muestra)</h4><canvas id="miniFuturos"></canvas></div>
        <div class="card p-4"><h4 class="font-semibold mb-2">Estacionalidad (muestra)</h4><canvas id="miniEstac"></canvas></div>
        <div class="card p-4"><h4 class="font-semibold mb-2">Índice Agro (muestra)</h4><canvas id="miniIndice"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Nosotros -->
  <section id="nosotros" class="section bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <h2 class="text-2xl font-bold mb-4">Nosotros</h2>
      <div class="grid md:grid-cols-2 gap-8">
        <div class="prose max-w-none">
          <p>Somos un equipo con enfoque en <strong>inteligencia de precios</strong> del agro colombiano. Combinamos datos de mercado, estacionalidad y referentes de futuros para entregar <em>insights</em> accionables a afiliados.</p>
          <p>Nuestro portal diferencia contenido público e información analítica de acceso restringido por credenciales.</p>
          <p>Transparencia metodológica: definiciones, fuentes y fórmulas documentadas.</p>
        </div>
        <div class="card p-6">
          <h3 class="font-semibold mb-2">Cobertura inicial</h3>
          <ul class="list-disc pl-5 text-gray-700 space-y-2">
            <li>Café pergamino, Maíz amarillo, Arroz paddy.</li>
            <li>Comparativos por región, curvas spot y futuros, estacionalidad.</li>
            <li>Descargas CSV con marca de agua (en versión productiva).</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Normativa (solo SFC) -->
  <section id="normativa" class="section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <h2 class="text-2xl font-bold mb-6">Normativa aplicable</h2>
      <div class="card p-6">
        <h3 class="font-semibold mb-3">Superintendencia Financiera de Colombia</h3>
        <ul class="space-y-2 text-secondary">
          <li><a class="underline" target="_blank" href="https://www.superfinanciera.gov.co/">Sitio oficial de la SFC</a></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- PQR -->
  <section id="pqr" class="section bg-white">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <h2 class="text-2xl font-bold mb-4">Peticiones, Quejas y Recursos (PQR)</h2>
      <form id="pqrForm" class="card p-6 space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Tipo</label>
            <select required id="pqrTipo" class="w-full border rounded-lg px-3 py-2">
              <option value="Petición">Petición</option>
              <option value="Queja">Queja</option>
              <option value="Recurso">Recurso</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Correo de contacto</label>
            <input required type="email" id="pqrEmail" class="w-full border rounded-lg px-3 py-2" placeholder="correo@dominio.com" />
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Descripción</label>
          <textarea required id="pqrDesc" class="w-full border rounded-lg px-3 py-2" rows="4" placeholder="Describe tu solicitud"></textarea>
        </div>
        <div class="flex items-center gap-3">
          <input id="pqrCaptcha" type="checkbox" required />
          <label for="pqrCaptcha" class="text-sm text-gray-600">No soy un robot</label>
        </div>
        <button class="btn btn-primary" type="submit">Radicar PQR</button>
        <p id="pqrOk" class="hidden text-green-700 font-medium"></p>
      </form>
    </div>
  </section>

  <!-- Sección privada (requiere login) -->
  <section id="dashboard" class="section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div id="privadoCapa" class="card p-8 text-center">
        <h3 class="text-xl font-semibold">Área privada</h3>
        <p class="text-gray-600 mt-2">Inicia sesión para acceder al panel de afiliado.</p>
        <button class="btn btn-primary mt-4" onclick="openLogin()">Iniciar sesión</button>
      </div>

      <div id="privadoContenido" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Panel general</h2>
        <!-- KPIs -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="card p-4"><div class="text-sm text-muted">Productos</div><div class="text-2xl font-bold">3</div></div>
          <div class="card p-4"><div class="text-sm text-muted">Regiones</div><div class="text-2xl font-bold">5</div></div>
          <div class="card p-4"><div class="text-sm text-muted">Series totales</div><div class="text-2xl font-bold">180</div></div>
          <div class="card p-4"><div class="text-sm text-muted">Actualización</div><div class="text-2xl font-bold">hoy</div></div>
        </div>

        <!-- Comparativos por producto entre regiones -->
        <div class="mt-6 card p-6">
          <div class="flex flex-wrap gap-4 items-end">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Producto</label>
              <select id="cmpProd" class="border rounded-lg px-3 py-2">
                <option value="cafe">Café pergamino</option>
                <option value="maiz">Maíz amarillo</option>
                <option value="arroz">Arroz paddy</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Horizonte</label>
              <select id="cmpHorizonte" class="border rounded-lg px-3 py-2">
                <option value="12m">12 meses</option>
                <option value="8w">8 semanas</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="renderComparativos()">Actualizar</button>
          </div>
          <div class="grid lg:grid-cols-2 gap-6 mt-4">
            <div>
              <h3 class="font-semibold mb-2">Comparativo por regiones — Spot</h3>
              <canvas id="cmpSpot"></canvas>
            </div>
            <div>
              <h3 class="font-semibold mb-2">Variación semanal por región</h3>
              <div id="wowGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
            </div>
          </div>
        </div>

        <!-- Tabs de mercado ampliadas -->
        <div class="mt-6">
          <div class="flex gap-2">
            <button class="btn tab-btn btn-primary" data-tab="spot">Spot</button>
            <button class="btn tab-btn btn-outline" data-tab="futuros">Futuros</button>
            <button class="btn tab-btn btn-outline" data-tab="estacionalidad">Estacionalidad</button>
            <button class="btn tab-btn btn-outline" data-tab="indices">Índices</button>
          </div>

          <div class="mt-4">
            <div id="tab-spot" class="card p-6">
              <h3 class="font-semibold mb-2">Precio spot (COP/kg)</h3>
              <canvas id="chartSpot"></canvas>
            </div>
            <div id="tab-futuros" class="card p-6 hidden">
              <h3 class="font-semibold mb-2">Curva de futuros (COP/kg)</h3>
              <canvas id="chartFuturos"></canvas>
            </div>
            <div id="tab-estacionalidad" class="card p-6 hidden">
              <h3 class="font-semibold mb-2">Estacionalidad (promedio 5 años y percentiles)</h3>
              <canvas id="chartEstacionalidad"></canvas>
            </div>
            <div id="tab-indices" class="card p-6 hidden">
              <h3 class="font-semibold mb-2">Índice Agro Tradition</h3>
              <canvas id="chartIndice"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-white border-t border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-sm text-gray-600 flex flex-col md:flex-row md:items-center gap-3 justify-between">
      <div class="flex items-center gap-2"><img src="/mnt/data/Logo - Tradition Colombia.png" alt="Tradition" class="h-5"/> <span>© <span id="year"></span> Tradition Colombia. Todos los derechos reservados.</span></div>
      <div class="flex gap-4">
        <a class="underline" target="_blank" href="https://www.superfinanciera.gov.co/">SFC</a>
        <a class="underline" href="#pqr">PQR</a>
      </div>
    </div>
  </footer>

  <!-- Modal Login -->
  <div id="modalLogin" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold">Iniciar sesión</h3>
        <button class="text-gray-500" onclick="closeLogin()">✕</button>
      </div>
      <p class="text-sm text-gray-600 mt-1">Acceso para afiliados registrados.</p>
      <form id="loginForm" class="mt-4 space-y-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Correo</label>
          <input type="email" id="loginEmail" class="w-full border rounded-lg px-3 py-2" placeholder="afiliado@tradition.co" required />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Contraseña</label>
          <input type="password" id="loginPass" class="w-full border rounded-lg px-3 py-2" placeholder="••••••••" required />
        </div>
        <button class="btn btn-primary w-full" type="submit">Entrar</button>
        <p class="text-xs text-gray-500">Demo: <code>afiliado@tradition.co</code> / <code>demo123</code></p>
        <p id="loginError" class="hidden text-red-600 text-sm"></p>
      </form>
    </div>
  </div>

  <script>
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => document.querySelectorAll(q);
    const fmtCOP = (n) => n.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });

    // NAV / AUTH
    const linkPrivado = $('#link-privado');
    const btnLogin = $('#btn-login');
    const btnLogout = $('#btn-logout');
    const ctaPanel = $('#cta-panel');

    function updateAuthUI() {
      const logged = localStorage.getItem('tc_logged') === '1';
      if (logged) {
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
        linkPrivado.classList.remove('hidden');
        $('#privadoCapa').classList.add('hidden');
        $('#privadoContenido').classList.remove('hidden');
      } else {
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
        linkPrivado.classList.add('hidden');
        $('#privadoCapa').classList.remove('hidden');
        $('#privadoContenido').classList.add('hidden');
      }
    }

    btnLogin.addEventListener('click', () => openLogin());
    btnLogout.addEventListener('click', () => { localStorage.removeItem('tc_logged'); updateAuthUI(); });
    ctaPanel?.addEventListener('click', (e) => { if (localStorage.getItem('tc_logged') !== '1') { e.preventDefault(); openLogin(); } });

    // LOGIN
    function openLogin(){ $('#modalLogin').classList.remove('hidden'); $('#modalLogin').classList.add('flex'); }
    function closeLogin(){ $('#modalLogin').classList.add('hidden'); $('#modalLogin').classList.remove('flex'); }
    $('#loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pass = $('#loginPass').value.trim();
      if (email === 'afiliado@tradition.co' && pass === 'demo123') {
        localStorage.setItem('tc_logged','1');
        updateAuthUI();
        closeLogin();
        location.hash = '#dashboard';
        // construir charts privados en el primer login
        setTimeout(buildPrivateCharts, 50);
        setTimeout(renderComparativos, 60);
      } else { const err = $('#loginError'); err.textContent = 'Credenciales inválidas'; err.classList.remove('hidden'); }
    });

    // DATA DUMMY (mensual y semanal por región)
    const labelsMes = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const regiones = ['huila','tolima','antioquia','santander','meta'];

    // Series mensuales por producto (promedio nacional)
    const serieCafe = [9800, 10200, 10100, 10500, 10800, 11000, 10900, 11200, 11500, 11600, 11750, 11800];
    const serieMaiz = [1800, 1850, 1900, 1950, 2050, 2100, 2080, 2120, 2150, 2200, 2220, 2250];
    const serieArroz = [1500, 1520, 1530, 1550, 1580, 1600, 1620, 1650, 1670, 1700, 1720, 1750];

    // Semanales por región (8 semanas) — por producto
    const weeks = ['-7','-6','-5','-4','-3','-2','-1','Actual'];
    const dataWeekly = {
      cafe: {
        huila:      [10800,10900,11000,10950,11050,11100,11150,11250],
        tolima:     [10600,10650,10750,10700,10800,10850,10920,10980],
        antioquia:  [10450,10550,10580,10600,10650,10750,10800,10850],
        santander:  [10300,10350,10420,10480,10520,10560,10600,10680],
        meta:       [10100,10150,10200,10250,10350,10400,10450,10520]
      },
      maiz: {
        huila:      [2100,2110,2120,2125,2130,2140,2145,2155],
        tolima:     [2050,2060,2075,2080,2085,2090,2100,2110],
        antioquia:  [2000,2010,2020,2030,2040,2050,2060,2070],
        santander:  [1980,1990,2000,2010,2015,2025,2030,2040],
        meta:       [1950,1955,1960,1970,1980,1990,1995,2005]
      },
      arroz: {
        huila:      [1620,1625,1630,1635,1640,1645,1650,1660],
        tolima:     [1600,1605,1610,1615,1620,1625,1630,1640],
        antioquia:  [1580,1585,1590,1595,1600,1605,1610,1620],
        santander:  [1570,1575,1580,1585,1590,1595,1600,1608],
        meta:       [1550,1555,1560,1565,1570,1575,1580,1590]
      }
    };

    // KPI variación WoW helper
    function wowPct(arr){ const n = arr.length; const prev = arr[n-2]; const curr = arr[n-1]; return ((curr - prev)/prev) * 100; }

    function setKPI(idVal, idBadge, value, pct){
      $(idVal).textContent = fmtCOP(value);
      const b = $(idBadge); const sign = pct >= 0 ? '+' : ''; const cls = pct >= 0 ? 'kpi-up' : 'kpi-down';
      b.className = `text-xs px-2 py-0.5 rounded-full ${cls}`;
      b.textContent = `${sign}${pct.toFixed(1)}% WoW`;
    }

    // HOME charts
    function buildHomeCharts(){
      // Público
      new Chart($('#chartPublic'), { type: 'line', data: { labels: labelsMes, datasets: [
        { label: 'Café', data: serieCafe, tension: .35 },
        { label: 'Maíz', data: serieMaiz, tension: .35 },
        { label: 'Arroz', data: serieArroz, tension: .35 }
      ]}, options: { plugins: { legend: { position: 'bottom' } }, scales: { y: { ticks: { callback: v => v.toLocaleString('es-CO') } } } } });
      // Mini futuros
      new Chart($('#miniFuturos'), { type:'line', data:{ labels:['M+1','M+2','M+3','M+4','M+5','M+6'], datasets:[{ label:'Curva', data:[11200,11300,11450,11520,11600,11650], tension:.25 }] }, options:{ plugins:{ legend:{display:false} }, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString('es-CO') } } } } });
      // Mini estacionalidad
      const prom5 = [9800,10000,10100,10300,10500,10700,10850,11000,11200,11300,11400,11500];
      new Chart($('#miniEstac'), { type:'line', data:{ labels:labelsMes, datasets:[{ label:'Prom 5a', data:prom5, tension:.25 }] }, options:{ plugins:{ legend:{display:false} } } });
      // Mini índice
      const idx = [100,101,102,101,103,104,105,106,108,109,110,111];
      new Chart($('#miniIndice'), { type:'line', data:{ labels:labelsMes, datasets:[{ label:'Índice', data:idx, tension:.2 }] }, options:{ plugins:{ legend:{display:false} } } });

      // KPIs (promedio últimas observaciones y WoW del país usando Huila como proxy)
      setKPI('#kpi-cafe',  '#kpi-cafe-wow',  serieCafe[serieCafe.length-1], wowPct(dataWeekly.cafe.huila));
      setKPI('#kpi-maiz',  '#kpi-maiz-wow',  serieMaiz[serieMaiz.length-1], wowPct(dataWeekly.maiz.huila));
      setKPI('#kpi-arroz', '#kpi-arroz-wow', serieArroz[serieArroz.length-1], wowPct(dataWeekly.arroz.huila));
      const indice = 111; const indicePrev = 110; setKPI('#kpi-indice', '#kpi-indice-wow', indice, ((indice-indicePrev)/indicePrev)*100);
    }

    // MAPA: al hacer clic fija región para comparativos
    $('#mapCol')?.addEventListener('click', (e)=>{
      if (e.target && e.target.dataset && e.target.dataset.region) {
        const r = e.target.dataset.region;
        localStorage.setItem('region_sel', r);
        if (localStorage.getItem('tc_logged')==='1') renderComparativos();
        location.hash = '#dashboard';
      }
    });

    // TABS
    $$('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      $$('.tab-btn').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline'); });
      btn.classList.add('btn-primary'); btn.classList.remove('btn-outline');
      ['spot','futuros','estacionalidad','indices'].forEach(id => {
        const el = document.getElementById('tab-'+id);
        if (id === tab) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
    }));

    // Charts privados base
    let chartSpot, chartFuturos, chartEst, chartIndice, chartCmp;

    function buildPrivateCharts(){
      // Spot
      chartSpot = new Chart($('#chartSpot'), { type: 'line', data: { labels: labelsMes, datasets: [ { label:'Precio spot', data: serieCafe, tension:.35, fill:false } ] }, options: { plugins:{ legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString('es-CO') } } } } });
      // Futuros
      const futLabels = ['M+1','M+2','M+3','M+4','M+5','M+6'];
      const futData = [11200, 11300, 11450, 11520, 11600, 11650];
      chartFuturos = new Chart($('#chartFuturos'), { type:'line', data:{ labels:futLabels, datasets:[ { label:'Curva', data:futData, tension:.2, fill:false } ] }, options:{ plugins:{ legend:{display:false} }, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString('es-CO') } } } } });
      // Estacionalidad
      const prom5 = [9800,10000,10100,10300,10500,10700,10850,11000,11200,11300,11400,11500];
      const p10 = prom5.map(v=>Math.round(v*0.95));
      const p90 = prom5.map(v=>Math.round(v*1.05));
      chartEst = new Chart($('#chartEstacionalidad'), { type:'line', data:{ labels:labelsMes, datasets:[
        { label:'P10', data:p10, tension:.3, fill:false },
        { label:'Promedio 5a', data:prom5, tension:.3, fill:true },
        { label:'P90', data:p90, tension:.3, fill:false },
      ]}, options:{ plugins:{ legend:{ position:'bottom'} }, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString('es-CO') } } } } });
      // Índice
      const idx = [100,101,102,101,103,104,105,106,108,109,110,111];
      chartIndice = new Chart($('#chartIndice'), { type:'line', data:{ labels:labelsMes, datasets:[ { label:'Índice', data:idx, tension:.25 } ] }, options:{ plugins:{ legend:{display:false} } } });
    }

    // Comparativos por regiones
    function renderComparativos(){
      const prod = $('#cmpProd').value; const horizon = $('#cmpHorizonte').value;
      const dict = { cafe: 'Café', maiz:'Maíz', arroz:'Arroz'};
      const dataset = dataWeekly[prod];
      const labels = horizon==='8w' ? weeks : labelsMes;
      const dataByRegion = {};
      regiones.forEach(r=>{ dataByRegion[r] = (horizon==='8w') ? dataset[r] : (prod==='cafe'?serieCafe:prod==='maiz'?serieMaiz:serieArroz); });

      // Chart comparativo
      const ds = regiones.map(r=>({ label: r.charAt(0).toUpperCase()+r.slice(1), data: dataByRegion[r], tension:.25 }));
      if (chartCmp) chartCmp.destroy();
      chartCmp = new Chart($('#cmpSpot'), { type:'line', data:{ labels, datasets: ds }, options:{ plugins:{ legend:{ position:'bottom'} }, scales:{ y:{ ticks:{ callback:v=>v.toLocaleString('es-CO') } } } } });

      // Variación WoW per región
      const grid = $('#wowGrid'); grid.innerHTML = '';
      regiones.forEach(r=>{
        const w = wowPct(dataset[r]);
        const cls = w>=0 ? 'kpi-up' : 'kpi-down';
        const el = document.createElement('div');
        el.className = `p-3 rounded-lg border ${cls}`;
        el.innerHTML = `<div class="text-xs font-semibold">${dict[prod]} · ${r}</div><div class="text-lg font-bold">${w>=0?'+':''}${w.toFixed(2)}%</div><div class="text-xs">vs semana pasada</div>`;
        grid.appendChild(el);
      });

      // Si usuario seleccionó región desde mapa, hacemos foco
      const sel = localStorage.getItem('region_sel');
      if (sel) { /* se podría resaltar la serie correspondiente en el futuro */ }
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#year').textContent = new Date().getFullYear();
      updateAuthUI();
      buildHomeCharts();
    });
  </script>
</body>
</html>
